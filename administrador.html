<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <title>Admin - Stratify</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Paleta de Colores para Administrador */
    :root {
        --bg-dark: #1a1e29;     /* Fondo Principal */
        --card-bg: #132d46;     /* Fondo de Tarjetas/Elementos Secundarios */
        --accent-teal: #01c38e; /* Acento Principal Brillante */
        --text-light: #ffffff;  /* Color de Texto CLARO */
        --text-secondary-readable: #a3b1c6; /* Gris claro para subt铆tulos/descripciones */
    }

    body { 
        background: var(--bg-dark);
        color: var(--text-light);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
        background-color: var(--card-bg) !important;
        border-bottom: 2px solid var(--accent-teal);
    }
    .navbar-light .navbar-brand {
        color: var(--accent-teal);
        font-weight: bold;
    }
    .card {
        background-color: var(--card-bg);
        border: 1px solid #2e4a6a;
        color: var(--text-light);
    }
    .btn-close-white {
        filter: invert(1);
    }
    .btn-primary {
        background-color: var(--accent-teal);
        border-color: var(--accent-teal);
        color: var(--bg-dark);
        font-weight: 600;
    }
    .btn-primary:hover {
        background-color: #00a87a;
        border-color: #00a87a;
    }
    .thumb { object-fit: cover; height: 100px; border-radius: .5rem; }
    .thumb-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.5rem; }
    .form-control, .form-control:focus {
        background-color: #0f2238;
        color: var(--text-light);
        border: 1px solid #2e4a6a;
    }
    .form-label {
        color: var(--accent-teal);
    }
    .list-group-item {
        background-color: var(--card-bg);
        border-color: #2e4a6a;
    }
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }
  </style>
</head>
<body class="pb-5">

<nav class="navbar navbar-light border-bottom sticky-top">
  <div class="container">
    <div class="d-flex align-items-center">
      <a href="index.html" class="btn btn-outline-secondary btn-sm me-2 text-white">
        <i class="bi bi-arrow-left"></i> Inicio
      </a>
      <h1 class="h3 mb-0 text-white">Panel de Administrador</h1>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cotizacionesModal">
            <i class="bi bi-file-text"></i> Ver Cotizaciones
        </button>
        <button class="btn btn-success" style="background:var(--accent-teal); border-color:var(--accent-teal);" data-bs-toggle="modal" data-bs-target="#productoModal">
            <i class="bi bi-plus-circle"></i> Nuevo Servicio
        </button>
    </div>
  </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4" style="color: var(--accent-teal);">Servicios en Venta</h2>
    <div id="productosAdmin" class="row">
        <p class="text-center text-muted">Cargando productos...</p>
    </div>
</div>

<div class="modal fade" id="productoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background: var(--card-bg); color: var(--text-light);">
            <div class="modal-header" style="border-bottom: 1px solid var(--accent-teal);">
                <h5 class="modal-title" style="color: var(--accent-teal);">A帽adir Nuevo Servicio</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="productoForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombreProducto" class="form-label">Nombre del Servicio *</label>
                        <input type="text" class="form-control" id="nombreProducto" required>
                    </div>
                    <div class="mb-3">
                        <label for="precioProducto" class="form-label">Precio (USD) *</label>
                        <input type="number" class="form-control" id="precioProducto" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionProducto" class="form-label">Descripci贸n *</label>
                        <textarea class="form-control" id="descripcionProducto" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="responsableProducto" class="form-label">Responsable del Servicio *</label>
                        <input type="text" class="form-control" id="responsableProducto" required>
                    </div>
                    <div class="mb-3">
                        <label for="imagenesProducto" class="form-label">Im谩genes (M煤ltiples Archivos)</label>
                        <input type="file" class="form-control" id="imagenesProducto" multiple accept="image/*">
                    </div>
                    <div id="previewImagenes" class="mb-3 thumb-grid"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitProductoBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" id="loadingSpinner"></span>
                        Guardar Servicio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="cotizacionesModal" tabindex="-1" aria-labelledby="cotizacionesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
        <div class="modal-content" style="background:var(--card-bg); color:var(--text-light);">
            <div class="modal-header" style="border-bottom: 1px solid var(--accent-teal);">
                <h5 class="modal-title" id="cotizacionesModalLabel" style="color:var(--accent-teal);">Gesti贸n de Cotizaciones de Clientes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="listaCotizacionesAdmin" class="list-group">
                    <p class="text-center text-muted">Cargando cotizaciones...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    //  LIMPIEZA DEL SERVICE WORKER (OPCIONAL PERO RECOMENDADO) 
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            for (let registration of registrations) {
                registration.unregister();
            }
        });
    }

    // --- CONFIGURACIN E IMPORTS DE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDlyA18XufNSSnF0pv5pc1lQIRNXkLAJAY",
        authDomain: "stratify-5cbc4.firebaseapp.com",
        projectId: "stratify-5cbc4",
        storageBucket: "stratify-5cbc4.firebasestorage.app",
        messagingSenderId: "843493852132",
        appId: "1:843493852132:web:e08e49ba0963e0ae73bdf1",
        measurementId: "G-NSHKMCZ95V"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const productosRef = collection(db, 'productos');
    const cotizacionesRef = collection(db, 'cotizaciones'); // Colecci贸n de cotizaciones

    // --- UTILIDADES ---
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alertDiv.style.zIndex = '1060';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }

    async function uploadImagesToCloudinary(files) {
        const urls = [];
        for (const file of files) {
            const storageRef = ref(storage, `productos/${Date.now()}-${file.name}`);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            urls.push(url);
        }
        return urls;
    }
    
    // --- LGICA DE PRODUCTOS ---
    const productoForm = document.getElementById('productoForm');
    const submitBtn = document.getElementById('submitProductoBtn');
    const spinner = document.getElementById('loadingSpinner');
    const previewDiv = document.getElementById('previewImagenes');
    const modal = new bootstrap.Modal(document.getElementById('productoModal'));

    document.getElementById('imagenesProducto').addEventListener('change', function(e) {
        previewDiv.innerHTML = '';
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.classList.add('thumb', 'img-thumbnail');
                previewDiv.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    });

    productoForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        spinner.classList.remove('d-none');

        const nombre = document.getElementById('nombreProducto').value;
        const precio = parseFloat(document.getElementById('precioProducto').value);
        const descripcion = document.getElementById('descripcionProducto').value;
        const responsable = document.getElementById('responsableProducto').value;
        const imagenesInput = document.getElementById('imagenesProducto');

        try {
            let imagenesUrls = [];

            if (imagenesInput.files.length > 0) {
                imagenesUrls = await uploadImagesToCloudinary(Array.from(imagenesInput.files));
            }

            await addDoc(productosRef, {
                nombre,
                precio,
                descripcion,
                responsable,
                imagenes: imagenesUrls,
                imagenUrl: imagenesUrls[0] || '',
                createdAt: serverTimestamp() 
            });

            showAlert('Producto guardado correctamente! (Se actualiza en Tienda)', 'success');
            
            e.target.reset();
            previewDiv.innerHTML = '';
            modal.hide();

        } catch (error) {
            console.error('Error guardando producto:', error);
            showAlert('Error al guardar el producto', 'danger');
        } finally {
            submitBtn.disabled = false;
            spinner.classList.add('d-none');
        }
    });

    // Cargar y Renderizar Productos (onSnapshot: Tiempo Real)
    const productosAdminDiv = document.getElementById('productosAdmin');
    onSnapshot(query(productosRef, orderBy('createdAt', 'desc')), (snapshot) => {
        productosAdminDiv.innerHTML = '';
        if (snapshot.empty) {
            productosAdminDiv.innerHTML = '<p class="text-center text-muted">A煤n no hay servicios en venta.</p>';
            return;
        }

        snapshot.forEach(doc => {
            const producto = doc.data();
            const div = document.createElement('div');
            div.classList.add('col-md-4', 'mb-4');
            div.innerHTML = `
                <div class="card h-100 shadow-sm">
                    <img src="${producto.imagenUrl || 'https://via.placeholder.com/300x200?text=Sin+Imagen'}" class="card-img-top" style="height: 180px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title text-white">${producto.nombre}</h5>
                        <p class="card-text text-secondary mb-1">Precio: $${producto.precio ? producto.precio.toFixed(2) : '0.00'}</p>
                        <p class="card-text text-secondary mb-3">Responsable: ${producto.responsable || 'N/A'}</p>
                        <button class="btn btn-danger btn-sm w-100" onclick="eliminarProducto('${doc.id}')">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;
            productosAdminDiv.appendChild(div);
        });
    }, (error) => {
        console.error("Error al cargar productos:", error);
        productosAdminDiv.innerHTML = '<p class="text-center text-danger">Error al conectar con la base de datos.</p>';
    });
    
    // Funci贸n de Eliminar Producto
    window.eliminarProducto = async function(id) {
        if (!confirm('驴Est谩s seguro de que quieres eliminar este servicio?')) return;
        try {
            await deleteDoc(doc(db, 'productos', id));
            showAlert('Servicio eliminado correctamente.', 'success');
        } catch (error) {
            console.error('Error al eliminar:', error);
            showAlert('Error al eliminar el servicio.', 'danger');
        }
    }


    // ----------------------------------------------------------------------
    // --- LGICA DE GESTIN DE COTIZACIONES (Punto 2) ---
    // ----------------------------------------------------------------------
    
    const listaCotizacionesAdminDiv = document.getElementById('listaCotizacionesAdmin');

    // Funci贸n para actualizar el estatus en Firestore
    window.updateEstatusCotizacion = async function(cotizacionId, selectElement) {
        const nuevoEstatus = selectElement.value;
        const cotizacionDocRef = doc(db, 'cotizaciones', cotizacionId);
        
        try {
            await updateDoc(cotizacionDocRef, {
                estatus: nuevoEstatus
            });
            showAlert(`Estatus de cotizaci贸n actualizado a: ${nuevoEstatus}`, 'info');
        } catch (error) {
            console.error('Error al actualizar estatus:', error);
            showAlert('Error al actualizar el estatus de la cotizaci贸n.', 'danger');
        }
    }
    
    // Escucha en tiempo real para Cotizaciones
    onSnapshot(query(cotizacionesRef, orderBy('createdAt', 'desc')), (snapshot) => {
        listaCotizacionesAdminDiv.innerHTML = '';
        if (snapshot.empty) {
            listaCotizacionesAdminDiv.innerHTML = '<p class="text-center text-muted">No hay cotizaciones de clientes.</p>';
            return;
        }

        snapshot.forEach(docSnap => {
            const cotizacion = docSnap.data();
            const id = docSnap.id;
            const fecha = cotizacion.createdAt ? new Date(cotizacion.createdAt.toDate()).toLocaleDateString() : 'N/A';
            
            // Determinar color de badge
            let badgeClass = 'bg-secondary';
            if (cotizacion.estatus.includes('Nuevo')) badgeClass = 'bg-danger';
            else if (cotizacion.estatus.includes('Revisi贸n')) badgeClass = 'bg-warning text-dark';
            else if (cotizacion.estatus.includes('Enviada')) badgeClass = 'bg-primary';
            else if (cotizacion.estatus.includes('Aceptada')) badgeClass = 'bg-success';
            else if (cotizacion.estatus.includes('Rechazada')) badgeClass = 'bg-dark';

            const item = document.createElement('div');
            item.classList.add('list-group-item', 'mb-3', 'p-3', 'rounded');
            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1 text-white">${cotizacion.nombre}</h5>
                    <small class="text-secondary">${fecha}</small>
                </div>
                <p class="mb-1 text-secondary"><strong>Email:</strong> ${cotizacion.email || 'N/A'} | <strong>Tel茅fono:</strong> ${cotizacion.telefono || 'N/A'}</p>
                <p class="mb-1 text-secondary"><strong>Servicios Solicitados:</strong> ${cotizacion.servicios || 'Ninguno'}</p>
                <p class="mb-2 text-white"><strong>Descripci贸n:</strong> ${cotizacion.descripcion}</p>
                
                <div class="d-flex align-items-center mt-3">
                    <label for="estatus-${id}" class="form-label mb-0 me-3 text-white">Cambiar Estatus:</label>
                    <select id="estatus-${id}" class="form-select w-50" 
                            style="background-color:#0f2238; color:white;"
                            onchange="updateEstatusCotizacion('${id}', this)">
                        <option value="Nuevo (Pendiente de Revisi贸n)" ${cotizacion.estatus === 'Nuevo (Pendiente de Revisi贸n)' ? 'selected' : ''}>Nuevo (Pendiente de Revisi贸n)</option>
                        <option value="En Revisi贸n" ${cotizacion.estatus === 'En Revisi贸n' ? 'selected' : ''}>En Revisi贸n</option>
                        <option value="Cotizaci贸n Enviada" ${cotizacion.estatus === 'Cotizaci贸n Enviada' ? 'selected' : ''}>Cotizaci贸n Enviada</option>
                        <option value="Aceptada" ${cotizacion.estatus === 'Aceptada' ? 'selected' : ''}>Aceptada</option>
                        <option value="Rechazada/Cerrada" ${cotizacion.estatus === 'Rechazada/Cerrada' ? 'selected' : ''}>Rechazada/Cerrada</option>
                    </select>
                    <span class="badge ${badgeClass} ms-3">Estatus actual: ${cotizacion.estatus}</span>
                </div>
            `;
            listaCotizacionesAdminDiv.appendChild(item);
        });
    }, (error) => {
        console.error("Error al cargar cotizaciones:", error);
        listaCotizacionesAdminDiv.innerHTML = '<p class="text-center text-danger">Error al cargar cotizaciones.</p>';
    });

</script>
</body>
</html>